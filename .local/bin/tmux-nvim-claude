#!/bin/bash

# Simple tmux setup for Claude Code workflow
# Purpose: Edit prompts in Neovim and send them to Claude Code for processing
# Creates a session with Neovim and Claude Code in vertical panes
# Allows sending prompts from Neovim to Claude Code using F12 or Alt+Enter

SESSION_NAME="claude-$(basename "$PWD")"
PROMPT_FILE="/tmp/instructions.prompt.md"

# Check if Claude Code is installed
if ! command -v claude &> /dev/null; then
	echo "Error: Claude Code is not installed or not in PATH"
	echo "Please install Claude Code first: https://docs.anthropic.com/en/docs/claude-code"
	exit 1
fi

# Kill existing session if it exists
tmux kill-session -t "$SESSION_NAME" 2> /dev/null || true

# Create empty prompt file
echo "" > "$PROMPT_FILE"

# Configure tmux session settings
tmux new-session -d -s "$SESSION_NAME" "nvim /tmp/instructions.prompt.md"

# Apply important tmux settings for this session
tmux set-option -t "$SESSION_NAME" base-index 1
tmux set-window-option -t "$SESSION_NAME" pane-base-index 1
tmux set-option -t "$SESSION_NAME" renumber-windows on
tmux set-option -t "$SESSION_NAME" mouse on

# Split window vertically and start claude in new pane
tmux split-window -h -t "$SESSION_NAME" "cd '$PWD' && claude"

# Wait for panes to be ready
sleep 2

# Focus on left pane (nvim)
tmux select-pane -t "$SESSION_NAME:1.1"

# Set up key bindings for F12 and Alt+Enter
tmux bind-key -n F12 run-shell 'bash -c "
    tmux send-keys -t $SESSION_NAME:1.1 Escape \":w\" Enter
    sleep 0.5
    if [ -f /tmp/instructions.prompt.md ] && [ -s /tmp/instructions.prompt.md ]; then
        tmux load-buffer -b claude-prompt /tmp/instructions.prompt.md
        tmux paste-buffer -b claude-prompt -t $SESSION_NAME:1.2
        tmux delete-buffer -b claude-prompt
        sleep 0.2
        tmux send-keys -t $SESSION_NAME:1.2 Enter
        echo \"\" > /tmp/instructions.prompt.md
    fi
    tmux select-pane -t $SESSION_NAME:1.1
"'
tmux bind-key -n M-Enter run-shell 'bash -c "
    tmux send-keys -t $SESSION_NAME:1.1 Escape \":w\" Enter
    sleep 0.5
    if [ -f /tmp/instructions.prompt.md ] && [ -s /tmp/instructions.prompt.md ]; then
        tmux load-buffer -b claude-prompt /tmp/instructions.prompt.md
        tmux paste-buffer -b claude-prompt -t $SESSION_NAME:1.2
        tmux delete-buffer -b claude-prompt
        sleep 0.2
        tmux send-keys -t $SESSION_NAME:1.2 Enter
        echo \"\" > /tmp/instructions.prompt.md
    fi
    tmux select-pane -t $SESSION_NAME:1.1
"'

# Focus on Neovim pane initially
tmux select-pane -t "$SESSION_NAME:1.1"

# Send 'i' key to nvim to enter insert mode
tmux send-keys -t "$SESSION_NAME:1.1" "i"

# Attach to session
tmux attach-session -t "$SESSION_NAME"