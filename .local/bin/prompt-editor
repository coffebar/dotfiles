#!/bin/bash

# Simple tmux setup for Claude Code workflow
# Purpose: Edit prompts in Neovim and send them to Claude Code for processing
# Creates a session with Neovim and Claude Code in vertical panes
# Allows sending prompts from Neovim to Claude Code using F12 or Alt+Enter
#
# Usage: prompt-editor [path_to_project]

OPTIONAL_PROJECT_PATH="$1"

# If a project path is provided, cd to it
if [ -n "$OPTIONAL_PROJECT_PATH" ]; then
	if [ -d "$OPTIONAL_PROJECT_PATH" ]; then
		cd "$OPTIONAL_PROJECT_PATH" || exit 1
	else
		echo "Error: Provided path '$OPTIONAL_PROJECT_PATH' is not a directory."
		exit 1
	fi
fi

PROJECT_NAME="$(basename "$PWD")"
SESSION_NAME="claude-$PROJECT_NAME"
PROMPT_FILE="/tmp/instructions.prompt.md"

# Check if Claude Code is installed
if ! command -v claude &> /dev/null; then
	echo "Error: Claude Code is not installed or not in PATH"
	echo "Please install Claude Code first: https://docs.anthropic.com/en/docs/claude-code"
	exit 1
fi

# Kill existing session if it exists
tmux kill-session -t "$SESSION_NAME" 2> /dev/null || true

# Create empty prompt file
echo "" > "$PROMPT_FILE"

# Configure tmux session settings
tmux new-session -d -s "$SESSION_NAME" "nvim /tmp/instructions.prompt.md"

# Apply important tmux settings for this session
tmux set-option -t "$SESSION_NAME" base-index 1
tmux set-window-option -t "$SESSION_NAME" pane-base-index 1
tmux set-option -t "$SESSION_NAME" renumber-windows on
tmux set-option -t "$SESSION_NAME" mouse on

# Split window vertically and start claude in new pane
tmux split-window -h -t "$SESSION_NAME" "cd '$PWD' && claude"

# Wait for panes to be ready
sleep 2

# Create a second window with nvim for code editing
tmux new-window -t "$SESSION_NAME:2" -n "editor" "nvim"

# Create a third window for telegram-claude-relay
RELAY_DIR="$HOME/pets/telegram-claude-relay"
PROJECT_ENV_FILE="$RELAY_DIR/.env.$PROJECT_NAME"

# Check if project-specific .env file exists
if [ -f "$PROJECT_ENV_FILE" ]; then
	SOCKET_PATH="$RELAY_DIR/telegram-relay-$PROJECT_NAME.sock"
	RELAY_START_CMD="./run.sh $PROJECT_NAME"
else
	SOCKET_PATH="$RELAY_DIR/telegram-relay.sock"
	RELAY_START_CMD="./run.sh"
fi

# Only start the relay if the socket file doesn't exist
if [ ! -e "$SOCKET_PATH" ]; then
	tmux new-window -t "$SESSION_NAME:3" -n "telegram-relay" "cd '$RELAY_DIR' && $RELAY_START_CMD"
fi

# Focus on left pane (nvim) in first window
tmux select-pane -t "$SESSION_NAME:1.1"

# Set up key bindings for F12 and Alt+Enter
tmux bind-key -n F12 run-shell 'bash -c "
    tmux send-keys -t $SESSION_NAME:1.1 Escape \":w\" Enter
    sleep 0.5
    if [ -f /tmp/instructions.prompt.md ] && [ -s /tmp/instructions.prompt.md ]; then
        tmux load-buffer -b claude-prompt /tmp/instructions.prompt.md
        tmux paste-buffer -b claude-prompt -t $SESSION_NAME:1.2
        tmux delete-buffer -b claude-prompt
        sleep 0.2
        tmux send-keys -t $SESSION_NAME:1.2 Enter
        echo \"\" > /tmp/instructions.prompt.md
        sleep 0.1
        tmux send-keys -t $SESSION_NAME:1.1 Escape \":edit\" Enter
    fi
    tmux select-pane -t $SESSION_NAME:1.1
"'
tmux bind-key -n M-Enter run-shell 'bash -c "
    tmux send-keys -t $SESSION_NAME:1.1 Escape \":w\" Enter
    sleep 0.5
    if [ -f /tmp/instructions.prompt.md ] && [ -s /tmp/instructions.prompt.md ]; then
        tmux load-buffer -b claude-prompt /tmp/instructions.prompt.md
        tmux paste-buffer -b claude-prompt -t $SESSION_NAME:1.2
        tmux delete-buffer -b claude-prompt
        sleep 0.2
        tmux send-keys -t $SESSION_NAME:1.2 Enter
        echo \"\" > /tmp/instructions.prompt.md
        sleep 0.1
        tmux send-keys -t $SESSION_NAME:1.1 Escape \":edit\" Enter
    fi
    tmux select-pane -t $SESSION_NAME:1.1
"'

# Focus on first window and Neovim pane initially
tmux select-window -t "$SESSION_NAME:1"
tmux select-pane -t "$SESSION_NAME:1.1"

# Send 'i' key to nvim to enter insert mode
tmux send-keys -t "$SESSION_NAME:1.1" "i"

# Attach to session
tmux attach-session -t "$SESSION_NAME"